<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Deck Match‑up Simulator</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--primary:#1a73e8;--surface:#fff;--surface-alt:#f1f3f4;--border:#e0e0e0;--success:#0b8043;--danger:#d93025;}
*{box-sizing:border-box;font-family:Roboto,sans-serif;margin:0;padding:0;}
body{background:var(--surface-alt);color:#202124;}
.wrapper{max-width:1200px;margin:auto;padding:24px;}
h1{font-size:1.6rem;font-weight:500;margin-bottom:20px;}
h2{font-size:1.1rem;font-weight:500;margin-bottom:10px;}
.card{background:var(--surface);border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.12);padding:18px;margin-bottom:26px;}
table{border-collapse:collapse;width:100%;font-size:.88rem;}
th,td{border:1px solid var(--border);padding:6px 8px;text-align:center;}
th{background:var(--surface-alt);white-space:nowrap;}
input[type="number"],input[type="text"],select{width:100%;padding:6px;border:none;border-radius:4px;background:#f8f9fa;text-align:center;}
input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{appearance:none;margin:0;}
button{background:var(--primary);color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;font-weight:500;}
button:hover{filter:brightness(1.05);}
.flex{display:flex;gap:16px;flex-wrap:wrap;align-items:center;}
.warn{background:#fce8e6;}
.delete-btn{background:none;border:none;font-size:1rem;color:var(--danger);cursor:pointer;}
details summary{cursor:pointer;font-weight:500;}
</style>
</head>
<body>
<div class="wrapper">
<h1>Deck Match‑up Simulator</h1>

<!-- Controls -->
<div class="card flex">
  <label>Mode
    <select id="mode-select"><option value="1">1‑on‑1</option><option value="3">3‑on‑3</option></select>
  </label>
  <label>Rounds <input id="rounds" type="number" value="5" min="1" style="width:4rem"></label>
  <button id="simulate">Simulate</button>
  <button id="add-deck">＋ Add Deck</button>
</div>

<!-- Deck table -->
<div class="card">
  <h2>Deck & Initial Share</h2>
  <table id="deck-table">
    <thead><tr><th>#</th><th>Deck Name</th><th>Initial %</th><th></th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- Matrix -->
<div class="card">
  <h2>Match‑up Matrix</h2>
  <div style="overflow:auto"><table id="matrix-table"></table></div>
</div>

<!-- Results -->
<div class="card" id="results"></div>
</div>
<datalist id="preset-names"></datalist>

<script>
/*** Constants ***/
const PRESETS=["青紫ルフィ","緑紫ルフィ","紫ルフィ","黒0ルッチ","黒ティーチ","赤黄ベティ","赤ゾロ","赤シャンクス","赤緑スモーカー","緑ボニー","緑黄ロー","青黄ナミ","黄エネル"];
const LABELS={fav:"有利",sFav:"微有利",even:"五分",sUnfav:"微不利",unfav:"不利"};
const REV={fav:"unfav",sFav:"sUnfav",even:"even",sUnfav:"sFav",unfav:"fav"};
const MAP1={fav:0.6,sFav:0.55,even:0.5,sUnfav:0.45,unfav:0.4};
const MAP3={fav:0.6,sFav:0.55,even:0.5,sUnfav:0.4,unfav:0.3};
const SCORE={fav:20,sFav:10,even:0,sUnfav:-10,unfav:-20};

/*** DOM refs ***/
const deckBody=document.querySelector('#deck-table tbody');
const matrix=document.getElementById('matrix-table');
const modeSel=document.getElementById('mode-select');

/*** Deck helpers ***/
function addRow(name="Deck",share=0){
  deckBody.insertAdjacentHTML('beforeend',
    `<tr><td></td><td><input list="preset-names" class="name-input" value="${name}"></td>
      <td><input type="number" class="share-input" value="${share}" min="0"></td>
      <td><button class="delete-btn">✖</button></td></tr>`);
  renumber();
}
function ensureOthers(){
  let last=deckBody.lastElementChild;
  if(!last||!last.dataset.other){
    addRow("Others",0);
    last=deckBody.lastElementChild;
    last.dataset.other=1;
    last.querySelector('.name-input').disabled=true;
    const s=last.querySelector('.share-input');s.id="other-share";s.disabled=true;
    last.querySelector('.delete-btn').remove();
  }
  limitShare();updateOthers();buildMatrix();
}
function renumber(){[...deckBody.rows].forEach((r,i)=>r.cells[0].textContent=i+1);}
function limitShare(){
  const max=modeSel.value==="3"?33.3:100;
  deckBody.querySelectorAll('.share-input').forEach(i=>i.max=max);
}
function updateOthers(){
  const sum=[...deckBody.rows].reduce((a,r)=>a+ +(r.dataset.other?0:r.querySelector('.share-input').value||0),0);
  const o=document.getElementById('other-share');if(o){o.value=(100-sum).toFixed(1);o.parentElement.classList.toggle('warn',sum>100);}
}

/*** Matrix ***/
let cat=[]; // category per cell
function optionHTML(){return Object.keys(LABELS).map(k=>`<option value="${k}">${LABELS[k]}</option>`).join('');}
function buildMatrix(){
  const n=deckBody.rows.length;
  if(!cat.length) cat=Array.from({length:n},()=>Array(n).fill("even"));  // 保持
  matrix.innerHTML='';
  const names=[...deckBody.rows].map(r=>r.cells[1].firstElementChild.value);
  matrix.insertAdjacentHTML('beforeend','<tr><th></th>'+names.map(n=>`<th>${n}</th>`).join('')+'</tr>');
  for(let i=0;i<n;i++){
    let row=`<tr><th>${names[i]}</th>`;
    for(let j=0;j<n;j++){
      if(i===j){row+='<td>—</td>';continue;}
      const val=cat[i]?.[j]||"even";
      if(j<i){
        row+=`<td class="mirror" data-i="${i}" data-j="${j}">${LABELS[val]}</td>`;
      }else{
        row+=`<td><select class="cat-select" data-i="${i}" data-j="${j}">${optionHTML()}</select></td>`;
      }
    }
    row+='</tr>';matrix.insertAdjacentHTML('beforeend',row);
  }
  /*** セレクトの値セット & 同期 ***/
  matrix.querySelectorAll('select.cat-select').forEach(sel=>{
    const i=+sel.dataset.i,j=+sel.dataset.j;
    sel.value=cat[i][j];
    sel.onchange=()=>{cat[i][j]=sel.value;cat[j][i]=REV[sel.value];
      const mir=matrix.querySelector(`td.mirror[data-i='${j}'][data-j='${i}']`);if(mir)mir.textContent=LABELS[REV[sel.value]];
    };
  });
}
/*** Name header update (軽量) ***/
function updateMatrixHeader(){
  const names=[...deckBody.rows].map(r=>r.cells[1].firstElementChild.value);
  matrix.querySelectorAll('tr:first-child th').forEach((th,i)=>{if(i)th.textContent=names[i-1];});
  matrix.querySelectorAll('tr:not(:first-child) th').forEach((th,i)=>th.textContent=names[i]);
}

/*** Simulation ***/
function p(catKey){return (modeSel.value==="3"?MAP3:MAP1)[catKey];}
function probMatrix(){
  const n=deckBody.rows.length,m=Array.from({length:n},()=>Array(n).fill(.5));
  for(let i=0;i<n;i++)for(let j=0;j<n;j++)if(i!==j)m[i][j]=p(cat[i][j]);
  return m;
}
function once(sh,m){
  const n=sh.length,nx=Array(n).fill(0);
  for(let i=0;i<n;i++){let e=0;for(let j=0;j<n;j++)e+=sh[j]*m[i][j];nx[i]=sh[i]*e*n;}
  const s=nx.reduce((a,b)=>a+b,0);return nx.map(x=>x/s);
}
function simulate(){
  updateOthers();
  const rounds=+document.getElementById('rounds').value;
  const decks=[...deckBody.rows].map(r=>({name:r.cells[1].firstElementChild.value,isOther:r.dataset.other}));
  let shares=decks.map((d,i)=>d.isOther?document.getElementById('other-share').value/100:+deckBody.rows[i].querySelector('.share-input').value/100);
  const m=probMatrix(),hist=[shares.slice()];
  for(let r=0;r<rounds;r++){shares=once(shares,m);hist.push(shares.slice());}
  results(decks,shares,hist);
}

/*** Results ***/
let chart;
function results(decks,final,hist){
  const res=document.getElementById('results');res.innerHTML='';
  const names=decks.map(d=>d.name);
  /* share table */
  let t='<details open><summary>Share by Round</summary><table><thead><tr><th>R</th>'+names.map(n=>`<th>${n}</th>`).join('')+'</tr></thead><tbody>';
  hist.forEach((row,i)=>{t+='<tr><th>'+i+'</th>'+row.map(v=>`<td>${(v*100).toFixed(1)}</td>`).join('')+'</tr>';});
  t+='</tbody></table></details>';res.innerHTML=t;
  /* bar chart */
  const cvs=document.createElement('canvas');res.appendChild(cvs);
  if(chart)chart.destroy();
  chart=new Chart(cvs,{type:'bar',data:{labels:names,datasets:[{data:final.map(v=>(v*100).toFixed(1)),label:'Final %'}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:100}}}});
}

/*** Events ***/
modeSel.onchange=limitShare;
deckBody.addEventListener('input',e=>{
  if(e.target.classList.contains('share-input'))updateOthers();
  if(e.target.classList.contains('name-input'))updateMatrixHeader();
});
deckBody.addEventListener('click',e=>{
  if(e.target.classList.contains('delete-btn')){
    const tr=e.target.closest('tr');if(tr.dataset.other)return;
    tr.remove();renumber();ensureOthers();
  }
});
document.getElementById('add-deck').onclick=()=>{
  const oth=deckBody.querySelector('tr[data-other]');
  oth.insertAdjacentHTML('beforebegin',`<tr><td></td><td><input list="preset-names" class="name-input" value="Deck ${deckBody.rows.length}"></td><td><input type="number" class="share-input" value="0"></td><td><button class="delete-btn">✖</button></td></tr>`);
  renumber();limitShare();updateOthers();updateMatrixHeader();
};
document.getElementById('simulate').onclick=simulate;

/*** Init ***/
PRESETS.forEach(p=>{const o=document.createElement('option');o.value=p;document.getElementById('preset-names').appendChild(o);});
PRESETS.forEach(n=>addRow(n,0));
ensureOthers();
</script>
</body>
</html>
